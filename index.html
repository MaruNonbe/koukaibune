<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ARå°éµœé£¼èˆŸ - River Edition</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
    #top-ui-container { position: fixed; top: 20px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
    #bottom-ui-container { position: fixed; bottom: 30px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
    .ui-bar, .pad-grid { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(8px); pointer-events: auto; }
    .ui-bar { display: flex; gap: 6px; padding: 5px 8px; border-radius: 15px; }
    .pad-grid { display: grid; gap: 8px; padding: 15px; border-radius: 20px; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); }
    .btn { width: 55px; height: 55px; background: #ffffff; border: none; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 22px; color: #556677; cursor: pointer; }
    .btn-icon { flex-direction: column; font-size: 10px; color: #333; }
    .btn-icon span { font-size: 18px; }
    .mode-switch { background: #333 !important; color: #fff !important; font-weight: bold; width: 80px !important; }
    .mode-gps { background: #007bff !important; }
    #debug-info { position: fixed; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); font-size: 10px; z-index: 10000; pointer-events: none; }
  </style>
</head>
<body>

<div id="debug-info">ãƒ¢ãƒ¼ãƒ‰: è‡ªç”±é…ç½® (Manual)</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true;"
  renderer="precision: mediump; antialias: true; alpha: true; colorManagement: true; exposure: 1.2;"
>
  <a-assets>
    <audio id="snd-horn" src="horn.mp3" preload="auto"></audio>
    </a-assets>

  <a-light type="ambient" color="#FFF" intensity="1.5"></a-light>
  <a-light type="directional" position="-1 4 2" intensity="1.0"></a-light>
  <a-light type="hemisphere" color="#FFF" groundColor="#444" intensity="1.2"></a-light>

  <a-camera id="main-camera" rotation-reader></a-camera>

  <a-entity id="ship"
            gltf-model="models/koukaihune.glb"
            position="0 -0.5 -15"
            rotation="0 180 0"
            scale="5.0 5.0 5.0">
    
    <a-entity id="bow-wave" visible="false">
      <a-plane position="-0.3 0 1.2" rotation="-90 20 0" width="0.8" height="1.2"
               material="src: url(https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/noise/noise.png); 
                         transparent: true; opacity: 0.6; shader: flat; color: #ffffff; side: double;"
               animation="property: scale; from: 0.2 0.2 1; to: 1.5 2.5 1; dur: 1000; loop: true; easing: easeOutQuad"
               animation__op="property: material.opacity; from: 0.6; to: 0; dur: 1000; loop: true">
      </a-plane>
      <a-plane position="0.3 0 1.2" rotation="-90 -20 0" width="0.8" height="1.2"
               material="src: url(https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/noise/noise.png); 
                         transparent: true; opacity: 0.6; shader: flat; color: #ffffff; side: double;"
               animation="property: scale; from: 0.2 0.2 1; to: 1.5 2.5 1; dur: 1000; loop: true; easing: easeOutQuad; delay: 200"
               animation__op="property: material.opacity; from: 0.6; to: 0; dur: 1000; loop: true; delay: 200">
      </a-plane>
    </a-entity>
  </a-entity>
</a-scene>

<div id="top-ui-container">
  <div class="ui-bar">
    <div class="btn mode-switch" id="btn-mode">GPS OFF</div>
    <div class="btn btn-icon" id="btn-horn"><span>ğŸ“¢</span><div>éŸ³</div></div>
    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span><div>+</div></div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span><div>-</div></div>
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span><div>æ’®</div></div>
  </div>
</div>

<div id="bottom-ui-container">
  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>
    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>
    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
const ship = document.querySelector('#ship');
const bowWave = document.querySelector('#bow-wave');
const camera = document.querySelector('#main-camera');
const btnMode = document.getElementById('btn-mode');
const debug = document.getElementById('debug-info');
const hornAudio = document.getElementById('snd-horn');

let isGpsMode = false;
let curScale = 5.0;
let state = { moving: 0, turning: 0 };
let zoomState = 0;

/* --- GPSåˆ¶å¾¡ (å¿…è¦ã«å¿œã˜ã¦åº§æ¨™ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„) --- */
const targetLat = 38.114742; 
const targetLon = 140.033621;

btnMode.onclick = () => {
  isGpsMode = !isGpsMode;
  if (isGpsMode) {
    btnMode.innerText = "GPS ON";
    btnMode.classList.add('mode-gps');
    debug.innerText = "ãƒ¢ãƒ¼ãƒ‰: GPSå›ºå®š";
    camera.setAttribute('gps-camera', 'simulateLatitude: 0; simulateLongitude: 0;');
    ship.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
    ship.removeAttribute('position'); 
  } else {
    location.reload(); 
  }
};

/* --- ãƒ”ãƒ³ãƒæ“ä½œ (2æœ¬æŒ‡æ‹¡å¤§) --- */
let initialDist = 0;
window.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    initialDist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
  }
}, {passive: false});

window.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && initialDist > 0) {
    const dist = Math.hypot(e.touches[0].pageX - e.touches[1].pageX, e.touches[0].pageY - e.touches[1].pageY);
    const diff = dist / initialDist;
    curScale *= diff;
    curScale = Math.max(0.1, Math.min(curScale, 50));
    ship.object3D.scale.set(curScale, curScale, curScale);
    initialDist = dist;
  }
}, {passive: false});

/* --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— --- */
function loop() {
  requestAnimationFrame(loop);
  if (!ship.object3D) return;
  const mesh = ship.object3D;

  // 1. èˆ¹ã®ã‚ãšã‹ãªæºã‚Œï¼ˆæµ®éŠæ„Ÿï¼‰
  mesh.rotation.z = Math.sin(Date.now() * 0.0015) * 0.02;

  // 2. æ³¢ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã®è¡¨ç¤ºåˆ¶å¾¡ (å‰é€²ä¸­ã®ã¿è¡¨ç¤º)
  if (state.moving > 0) {
    bowWave.setAttribute('visible', 'true');
  } else {
    bowWave.setAttribute('visible', 'false');
  }

  // 3. å›è»¢å‡¦ç†
  if (state.turning !== 0) {
    mesh.rotation.y += THREE.MathUtils.degToRad(1.0) * state.turning;
  }

  // 4. ç§»å‹•å‡¦ç†
  if (state.moving !== 0) {
    const forward = new THREE.Vector3(0, 0, 1);
    forward.applyQuaternion(mesh.quaternion);
    mesh.position.addScaledVector(forward, state.moving * 0.04); // èˆ¹ã‚‰ã—ã„é€Ÿåº¦ã«å¾®èª¿æ•´
  }

  // 5. ãƒœã‚¿ãƒ³ã‚ºãƒ¼ãƒ 
  if (zoomState !== 0) {
    curScale += zoomState * 0.05;
    curScale = Math.max(0.1, curScale);
    mesh.scale.set(curScale, curScale, curScale);
  }
}
loop();

/* --- æ“ä½œãƒœã‚¿ãƒ³ç™»éŒ² --- */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if(!btn) return;
  const start = (e) => { if(e.cancelable) e.preventDefault(); state.moving = moveVal; state.turning = turnVal; };
  const end = (e) => { if(e.cancelable) e.preventDefault(); state.moving = 0; state.turning = 0; };
  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

setAction('btn-fwd', 1, 0);
setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1);
setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1);
setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1);
setAction('btn-curve-right-back', -1, -1);

document.getElementById('btn-stop').onclick = () => { state.moving = 0; state.turning = 0; };

const startZoomIn = (e) => { if(e.cancelable) e.preventDefault(); zoomState = 1; };
const startZoomOut = (e) => { if(e.cancelable) e.preventDefault(); zoomState = -1; };
const stopZoom = (e) => { if(e.cancelable) e.preventDefault(); zoomState = 0; };
document.getElementById('btn-zoom-in').addEventListener('touchstart', startZoomIn, {passive:false});
document.getElementById('btn-zoom-out').addEventListener('touchstart', startZoomOut, {passive:false});
window.addEventListener('touchend', stopZoom);

document.getElementById('btn-horn').onclick = () => { hornAudio.play(); };
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  cvs.toBlob(b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='ar_snapshot.png'; a.click(); });
};
</script>
</body>
</html>