<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>ARå°éµœé£¼èˆŸ - River Edition</title>

  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>

  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background: #000; font-family: sans-serif; }
    #top-ui-container { position: fixed; top: 20px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; }
    #bottom-ui-container { position: fixed; bottom: 30px; left: 0; width: 100%; z-index: 9999; display: flex; flex-direction: column; align-items: center; gap: 10px; pointer-events: none; }
    .ui-bar, .pad-grid { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(8px); pointer-events: auto; }
    .ui-bar { display: flex; gap: 6px; padding: 5px 8px; border-radius: 15px; }
    .pad-grid { display: grid; gap: 8px; padding: 15px; border-radius: 20px; grid-template-columns: repeat(3, 60px); grid-template-rows: repeat(3, 60px); }
    .btn { width: 55px; height: 55px; background: #ffffff; border: none; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 22px; color: #556677; cursor: pointer; user-select: none; -webkit-user-select: none; }
    .btn-icon { flex-direction: column; font-size: 10px; color: #333; }
    .btn-icon span { font-size: 18px; }
    .mode-switch { background: #333 !important; color: #fff !important; font-weight: bold; width: 80px !important; }
    .mode-gps { background: #007bff !important; }
    #debug-info { position: fixed; bottom: 10px; left: 10px; color: white; background: rgba(0,0,0,0.5); font-size: 10px; z-index: 10000; pointer-events: none; padding: 6px 8px; border-radius: 6px; white-space: pre-line; }
  </style>
</head>

<body>
<div id="debug-info">ãƒ¢ãƒ¼ãƒ‰: è‡ªç”±é…ç½® (Manual)</div>

<a-scene
  vr-mode-ui="enabled: false"
  embedded
  arjs="sourceType: webcam; debugUIEnabled: false; videoTexture: true; facingMode: environment;"
  renderer="precision: mediump; antialias: true; alpha: true; colorManagement: true; exposure: 1.2;"
>
  <a-assets>
    <audio id="snd-horn" src="horn.mp3" preload="auto"></audio>
  </a-assets>

  <a-light type="ambient" color="#FFF" intensity="1.5"></a-light>
  <a-light type="directional" position="-1 4 2" intensity="1.0"></a-light>
  <a-light type="hemisphere" color="#FFF" groundColor="#444" intensity="1.2"></a-light>

  <a-camera id="main-camera"></a-camera>

  <a-entity id="ship"
            gltf-model="models/koukaihune.glb"
            position="0 -0.5 -15"
            rotation="0 180 0"
            scale="5.0 5.0 5.0">

    <!-- âœ… æ³¢ï¼šèˆ¹ã®ã€Œå…ˆé ­æ–¹å‘ï¼ˆ-Xï¼‰ã€ã«åˆã‚ã›ã¦é…ç½®ã—ç›´ã— -->
    <a-entity id="bow-wave" visible="false">
      <!-- å·¦å´ã®æ³¢ï¼ˆå…ˆé ­ = -X / å·¦å³ = Z ã§æŒ¯ã‚‹ï¼‰ -->
      <a-plane position="-1.2 0 -0.3" rotation="-90 -70 0" width="0.8" height="1.2"
               material="src: url(https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/noise/noise.png);
                         transparent: true; opacity: 0.6; shader: flat; color: #ffffff; side: double;"
               animation="property: scale; from: 0.2 0.2 1; to: 1.5 2.5 1; dur: 1000; loop: true; easing: easeOutQuad"
               animation__op="property: material.opacity; from: 0.6; to: 0; dur: 1000; loop: true">
      </a-plane>

      <!-- å³å´ã®æ³¢ -->
      <a-plane position="-1.2 0 0.3" rotation="-90 -110 0" width="0.8" height="1.2"
               material="src: url(https://raw.githubusercontent.com/aframevr/sample-assets/master/assets/images/noise/noise.png);
                         transparent: true; opacity: 0.6; shader: flat; color: #ffffff; side: double;"
               animation="property: scale; from: 0.2 0.2 1; to: 1.5 2.5 1; dur: 1000; loop: true; easing: easeOutQuad; delay: 200"
               animation__op="property: material.opacity; from: 0.6; to: 0; dur: 1000; loop: true; delay: 200">
      </a-plane>
    </a-entity>

  </a-entity>
</a-scene>

<div id="top-ui-container">
  <div class="ui-bar">
    <div class="btn mode-switch" id="btn-mode">GPS OFF</div>
    <div class="btn btn-icon" id="btn-horn"><span>ğŸ“¢</span><div>éŸ³</div></div>

    <div class="btn btn-icon" id="btn-height-up"><span>â¬†ï¸</span><div>é«˜+</div></div>
    <div class="btn btn-icon" id="btn-height-down"><span>â¬‡ï¸</span><div>é«˜-</div></div>

    <div class="btn btn-icon" id="btn-zoom-in"><span>ğŸ”</span><div>+</div></div>
    <div class="btn btn-icon" id="btn-zoom-out"><span>ğŸ”</span><div>-</div></div>
    <div class="btn btn-icon" id="btn-capture"><span>ğŸ“·</span><div>æ’®</div></div>
  </div>
</div>

<div id="bottom-ui-container">
  <div class="pad-grid">
    <div class="btn" id="btn-curve-left-fwd">â†–</div>
    <div class="btn" id="btn-fwd">â†‘</div>
    <div class="btn" id="btn-curve-right-fwd">â†—</div>
    <div class="btn" id="btn-turn-left">â†º</div>
    <div class="btn btn-stop" id="btn-stop">STOP</div>
    <div class="btn" id="btn-turn-right">â†»</div>
    <div class="btn" id="btn-curve-left-back">â†™</div>
    <div class="btn" id="btn-back">â†“</div>
    <div class="btn" id="btn-curve-right-back">â†˜</div>
  </div>
</div>

<script>
const ship = document.querySelector('#ship');
const bowWave = document.querySelector('#bow-wave');
const camera = document.querySelector('#main-camera');
const btnMode = document.getElementById('btn-mode');
const debug = document.getElementById('debug-info');
const hornAudio = document.getElementById('snd-horn');

const THREE = AFRAME.THREE;

let isGpsMode = false;
let curScale = 5.0;
let state = { moving: 0, turning: 0 };
let zoomState = 0;
let heightState = 0;

/* --- GPSåº§æ¨™ --- */
const targetLat = 38.114742;
const targetLon = 140.033621;

/* âœ… èˆ¹ãƒ¢ãƒ‡ãƒ«ã®ã€Œå‰æ–¹å‘ã€ã‚’ -X ã«çµ±ä¸€ï¼ˆã“ã“ãŒâ€œé€†æ³¢â€ã®åŸå› ã ã£ãŸç®‡æ‰€ï¼‰ */
const MODEL_FORWARD_LOCAL = new THREE.Vector3(-1, 0, 0);

/* âœ… iOS: ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³/å‘ã è¨±å¯ */
async function requestMotionPermissionIfNeeded() {
  try {
    if (typeof DeviceOrientationEvent !== 'undefined' &&
        typeof DeviceOrientationEvent.requestPermission === 'function') {
      const res = await DeviceOrientationEvent.requestPermission();
      if (res !== 'granted') throw new Error('DeviceOrientation permission denied');
    }
    if (typeof DeviceMotionEvent !== 'undefined' &&
        typeof DeviceMotionEvent.requestPermission === 'function') {
      const res2 = await DeviceMotionEvent.requestPermission();
      if (res2 !== 'granted') throw new Error('DeviceMotion permission denied');
    }
    return true;
  } catch (e) {
    console.warn(e);
    alert('ãƒ¢ãƒ¼ã‚·ãƒ§ãƒ³ã‚»ãƒ³ã‚µãƒ¼ã®è¨±å¯ãŒå¿…è¦ã§ã™ï¼ˆAllow ã‚’é¸æŠã—ã¦ãã ã•ã„ï¼‰');
    return false;
  }
}

btnMode.onclick = async () => {
  const ok = await requestMotionPermissionIfNeeded();
  if (!ok) return;

  isGpsMode = !isGpsMode;

  if (isGpsMode) {
    btnMode.innerText = "GPS ON";
    btnMode.classList.add('mode-gps');
    debug.innerText = "ãƒ¢ãƒ¼ãƒ‰: GPSå›ºå®šï¼ˆä½ç½®å–å¾—ä¸­â€¦ï¼‰";

    camera.setAttribute('gps-camera', 'gpsMinDistance: 0; gpsTimeInterval: 1000;');
    ship.setAttribute('gps-entity-place', `latitude: ${targetLat}; longitude: ${targetLon};`);
    ship.removeAttribute('position');

    window.addEventListener('gps-camera-update-position', (e) => {
      const { latitude, longitude, accuracy } = e.detail.position;
      debug.innerText =
        `ãƒ¢ãƒ¼ãƒ‰: GPSå›ºå®š\nç¾åœ¨åœ°: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}\nç²¾åº¦: Â±${Math.round(accuracy)}m`;
    });
  } else {
    location.reload();
  }
};

/* --- ãƒ”ãƒ³ãƒæ“ä½œï¼ˆ2æœ¬æŒ‡æ‹¡å¤§ï¼‰--- */
let initialDist = 0;
window.addEventListener('touchstart', e => {
  if (e.touches.length === 2) {
    initialDist = Math.hypot(
      e.touches[0].pageX - e.touches[1].pageX,
      e.touches[0].pageY - e.touches[1].pageY
    );
  }
}, {passive: true});

window.addEventListener('touchmove', e => {
  if (e.touches.length === 2 && initialDist > 0) {
    if (e.cancelable) e.preventDefault();
    const dist = Math.hypot(
      e.touches[0].pageX - e.touches[1].pageX,
      e.touches[0].pageY - e.touches[1].pageY
    );
    const diff = dist / initialDist;
    curScale *= diff;
    curScale = Math.max(0.1, Math.min(curScale, 50));
    ship.object3D.scale.set(curScale, curScale, curScale);
    initialDist = dist;
  }
}, {passive: false});

/* --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— --- */
function loop() {
  requestAnimationFrame(loop);
  if (!ship.object3D) return;

  const mesh = ship.object3D;

  // 1) èˆ¹ã®æºã‚Œ
  mesh.rotation.z = Math.sin(Date.now() * 0.0015) * 0.02;

  // 2) æ³¢ï¼šå‰é€²ä¸­ï¼ˆâ†‘ï¼‰ã®ã¿è¡¨ç¤ºï¼ˆMODEL_FORWARD_LOCAL ã‚’ç›´ã—ãŸã®ã§é€†ã«ãªã‚‰ãªã„ï¼‰
  bowWave.setAttribute('visible', state.moving > 0 ? 'true' : 'false');

  // 3) å›è»¢
  if (state.turning !== 0) {
    mesh.rotation.y += THREE.MathUtils.degToRad(1.0) * state.turning;
  }

  // 4) ç§»å‹•ï¼ˆManualæ™‚ã®ã¿ï¼‰
  if (!isGpsMode && state.moving !== 0) {
    const forward = MODEL_FORWARD_LOCAL.clone().applyQuaternion(mesh.quaternion).normalize();
    mesh.position.addScaledVector(forward, state.moving * 0.04);
  }

  // 5) ã‚ºãƒ¼ãƒ 
  if (zoomState !== 0) {
    curScale += zoomState * 0.05;
    curScale = Math.max(0.1, curScale);
    mesh.scale.set(curScale, curScale, curScale);
  }

  // 6) é«˜ã•èª¿æ•´ï¼ˆManualæ™‚ã®ã¿ï¼‰
  if (!isGpsMode && heightState !== 0) {
    mesh.position.y += heightState * 0.02;
  }

  if (!isGpsMode) {
    debug.innerText = `ãƒ¢ãƒ¼ãƒ‰: è‡ªç”±é…ç½® (Manual)\né«˜ã•Y: ${mesh.position.y.toFixed(2)}`;
  }
}
loop();

/* --- æ“ä½œãƒœã‚¿ãƒ³ç™»éŒ² --- */
function setAction(id, moveVal, turnVal) {
  const btn = document.getElementById(id);
  if (!btn) return;

  const start = (e) => {
    if (e && e.cancelable) e.preventDefault();
    state.moving = moveVal;
    state.turning = turnVal;
  };
  const end = (e) => {
    if (e && e.cancelable) e.preventDefault();
    state.moving = 0;
    state.turning = 0;
  };

  btn.addEventListener('touchstart', start, {passive:false});
  btn.addEventListener('touchend', end, {passive:false});
  btn.addEventListener('touchcancel', end, {passive:false});
  btn.addEventListener('mousedown', start);
  btn.addEventListener('mouseup', end);
  btn.addEventListener('mouseleave', end);
}

setAction('btn-fwd', 1, 0);
setAction('btn-back', -1, 0);
setAction('btn-turn-left', 0, 1);
setAction('btn-turn-right', 0, -1);
setAction('btn-curve-left-fwd', 1, 1);
setAction('btn-curve-right-fwd', 1, -1);
setAction('btn-curve-left-back', -1, 1);
setAction('btn-curve-right-back', -1, -1);

document.getElementById('btn-stop').onclick = () => { state.moving = 0; state.turning = 0; };

/* âœ… ã‚ºãƒ¼ãƒ ï¼ˆwindowã«touchendã‚’ä»˜ã‘ãªã„ï¼‰ */
const zoomInBtn = document.getElementById('btn-zoom-in');
const zoomOutBtn = document.getElementById('btn-zoom-out');

const startZoomIn = (e) => { if(e.cancelable) e.preventDefault(); zoomState = 1; };
const startZoomOut = (e) => { if(e.cancelable) e.preventDefault(); zoomState = -1; };
const stopZoom = () => { zoomState = 0; };

zoomInBtn.addEventListener('touchstart', startZoomIn, {passive:false});
zoomOutBtn.addEventListener('touchstart', startZoomOut, {passive:false});
zoomInBtn.addEventListener('touchend', stopZoom, {passive:true});
zoomOutBtn.addEventListener('touchend', stopZoom, {passive:true});
zoomInBtn.addEventListener('touchcancel', stopZoom, {passive:true});
zoomOutBtn.addEventListener('touchcancel', stopZoom, {passive:true});

/* âœ… é«˜ã•ï¼ˆæŠ¼ã—ã¦ã‚‹é–“ã ã‘ä¸Šä¸‹ï¼‰ */
const heightUpBtn = document.getElementById('btn-height-up');
const heightDownBtn = document.getElementById('btn-height-down');

const startHeightUp = (e) => { if(e.cancelable) e.preventDefault(); heightState = 1; };
const startHeightDown = (e) => { if(e.cancelable) e.preventDefault(); heightState = -1; };
const stopHeight = () => { heightState = 0; };

heightUpBtn.addEventListener('touchstart', startHeightUp, {passive:false});
heightDownBtn.addEventListener('touchstart', startHeightDown, {passive:false});
heightUpBtn.addEventListener('touchend', stopHeight, {passive:true});
heightDownBtn.addEventListener('touchend', stopHeight, {passive:true});
heightUpBtn.addEventListener('touchcancel', stopHeight, {passive:true});
heightDownBtn.addEventListener('touchcancel', stopHeight, {passive:true});

/* --- horn --- */
document.getElementById('btn-horn').onclick = () => { hornAudio.play(); };

/* --- ã‚­ãƒ£ãƒ—ãƒãƒ£ --- */
document.getElementById('btn-capture').onclick = () => {
  const cvs = document.querySelector('canvas');
  if (!cvs) return;
  cvs.toBlob(b => {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(b);
    a.download = 'ar_snapshot.png';
    a.click();
  });
};
</script>
</body>
</html>